<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Processing App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .hidden {
            display: none;
        }
        
        .login-form {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, select, button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 10px;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        .btn-danger {
            background-color: #dc3545;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn-success {
            background-color: #28a745;
        }
        
        .btn-success:hover {
            background-color: #218838;
        }
        
        .status-message {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        .processing-options {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .user-info {
            font-size: 14px;
            color: #666;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .tab.active {
            border-bottom-color: #007bff;
            color: #007bff;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .progress-bar {
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            height: 20px;
        }
        
        .progress-fill {
            background-color: #28a745;
            height: 100%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div id="loginSection" class="container">
        <h1>Video Processing App - Login</h1>
        <div class="login-form">
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" value="user1" required>
            </div>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" value="password123" required>
            </div>
            <button onclick="login()">Login</button>
        </div>
        <div id="loginStatus"></div>
    </div>

    <!-- Main App Section -->
    <div id="appSection" class="hidden">
        <div class="container">
            <div class="header">
                <h1>Video Processing Dashboard</h1>
                <div class="user-info">
                    Welcome, <span id="currentUser"></span>
                    <button onclick="logout()" class="btn-danger" style="width: auto; margin-left: 10px;">Logout</button>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab active" onclick="switchTab('upload')">Upload & Process</div>
                <div class="tab" onclick="switchTab('videos')">My Videos</div>
                <div class="tab" onclick="switchTab('jobs')">Processing Jobs</div>
            </div>
            
            <!-- Upload Tab -->
            <div id="uploadTab" class="tab-content active">
                <h3>Upload Video</h3>
                <div class="form-group">
                    <label for="videoFile">Select Video File (MP4, AVI, MOV):</label>
                    <input type="file" id="videoFile" accept="video/*">
                </div>
                <button onclick="uploadVideo()" class="btn-success">Upload Video</button>
                <div id="uploadStatus"></div>
                
                <hr style="margin: 30px 0;">
                
                <h3>Process Video</h3>
                <div class="form-group">
                    <label for="videoSelect">Select Video to Process:</label>
                    <select id="videoSelect">
                        <option value="">Select a video...</option>
                    </select>
                </div>
                
                <div class="processing-options">
                    <div class="form-group">
                        <label for="format">Output Format:</label>
                        <select id="format">
                            <option value="mp4">MP4</option>
                            <option value="avi">AVI</option>
                            <option value="mov">MOV</option>
                            <option value="dash">DASH</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="resolution">Resolution:</label>
                        <select id="resolution">
                            <option value="480p">480p</option>
                            <option value="720p" selected>720p</option>
                            <option value="1080p">1080p</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="bitrate">Bitrate:</label>
                        <select id="bitrate">
                            <option value="500k">500k</option>
                            <option value="1000k" selected>1000k</option>
                            <option value="2000k">2000k</option>
                            <option value="5000k">5000k</option>
                        </select>
                    </div>
                </div>
                
                <button onclick="processVideo()" class="btn-success">Start Processing</button>
                <div id="processStatus"></div>
            </div>
            
            <!-- Videos Tab -->
            <div id="videosTab" class="tab-content">
                <h3>My Videos</h3>
                <button onclick="loadVideos()" class="btn-success">Refresh Videos</button>
                <div id="videosList"></div>
            </div>
            
            <!-- Jobs Tab -->
            <div id="jobsTab" class="tab-content">
                <h3>Processing Jobs</h3>
                <button onclick="loadJobs()" class="btn-success">Refresh Jobs</button>
                <div id="jobsList"></div>
            </div>
        </div>
    </div>

    <script>
        let authToken = '';
        let currentUsername = '';
        
        // API base URL
        const API_BASE = '/api';
        
        // Utility function to make API calls
        async function apiCall(endpoint, method = 'GET', body = null, isFormData = false) {
            const config = {
                method,
                headers: {}
            };
            
            if (authToken) {
                config.headers['Authorization'] = `Bearer ${authToken}`;
            }
            
            if (body && !isFormData) {
                config.headers['Content-Type'] = 'application/json';
                config.body = JSON.stringify(body);
            } else if (body && isFormData) {
                config.body = body;
            }
            
            try {
                const response = await fetch(endpoint, config);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Request failed');
                }
                
                return data;
            } catch (error) {
                throw error;
            }
        }
        
        // Show status message
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status-message ${type}">${message}</div>`;
        }
        
        // Login function
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showStatus('loginStatus', 'Please enter username and password', 'error');
                return;
            }
            
            try {
                showStatus('loginStatus', 'Logging in...', 'info');
                const response = await apiCall(`${API_BASE}/users/login`, 'POST', { username, password });
                
                authToken = response.authToken;
                currentUsername = username;
                
                showStatus('loginStatus', 'Login successful!', 'success');
                
                // Switch to main app
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('appSection').classList.remove('hidden');
                document.getElementById('currentUser').textContent = currentUsername;
                
                // Load initial data
                loadVideos();
                loadJobs();
                
            } catch (error) {
                showStatus('loginStatus', `Login failed: ${error.message}`, 'error');
            }
        }
        
        // Logout function
        function logout() {
            authToken = '';
            currentUsername = '';
            
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('appSection').classList.add('hidden');
            
            // Clear forms
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            showStatus('loginStatus', '', 'info');
        }
        
        // Tab switching
        function switchTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }
        
        // Upload video
        async function uploadVideo() {
            const fileInput = document.getElementById('videoFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showStatus('uploadStatus', 'Please select a video file', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('videoFile', file);
            
            try {
                showStatus('uploadStatus', 'Uploading video...', 'info');
                const response = await apiCall(`${API_BASE}/videos/upload`, 'POST', formData, true);
                
                showStatus('uploadStatus', `Video uploaded successfully! ID: ${response.videoId}`, 'success');
                
                // Refresh video list
                loadVideos();
                
                // Clear file input
                fileInput.value = '';
                
            } catch (error) {
                showStatus('uploadStatus', `Upload failed: ${error.message}`, 'error');
            }
        }
        
        // Load videos
        async function loadVideos() {
            try {
                const response = await apiCall(`${API_BASE}/videos`);
                const videos = response.videos || [];
                
                // Update video select dropdown
                const videoSelect = document.getElementById('videoSelect');
                videoSelect.innerHTML = '<option value="">Select a video...</option>';
                
                // Update videos list
                let videosHtml = '';
                
                if (videos.length === 0) {
                    videosHtml = '<p>No videos uploaded yet.</p>';
                } else {
                    videosHtml = `
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Original Name</th>
                                    <th>Size</th>
                                    <th>Type</th>
                                    <th>Uploaded</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    videos.forEach(video => {
                        videoSelect.innerHTML += `<option value="${video.id}">${video.original_name}</option>`;
                        
                        const size = (video.file_size / 1024 / 1024).toFixed(2);
                        const uploadedDate = new Date(video.uploaded_at).toLocaleString();
                        
                        videosHtml += `
                            <tr>
                                <td>${video.id}</td>
                                <td>${video.original_name}</td>
                                <td>${size} MB</td>
                                <td>${video.mime_type}</td>
                                <td>${uploadedDate}</td>
                            </tr>
                        `;
                    });
                    
                    videosHtml += '</tbody></table>';
                }
                
                document.getElementById('videosList').innerHTML = videosHtml;
                
            } catch (error) {
                document.getElementById('videosList').innerHTML = `<div class="status-message error">Failed to load videos: ${error.message}</div>`;
            }
        }
        
        // Process video
        async function processVideo() {
            const videoId = document.getElementById('videoSelect').value;
            const format = document.getElementById('format').value;
            const resolution = document.getElementById('resolution').value;
            const bitrate = document.getElementById('bitrate').value;
            
            if (!videoId) {
                showStatus('processStatus', 'Please select a video to process', 'error');
                return;
            }
            
            try {
                showStatus('processStatus', 'Starting video processing...', 'info');
                const response = await apiCall(`${API_BASE}/videos/process`, 'POST', {
                    videoId,
                    format,
                    resolution,
                    bitrate
                });
                
                showStatus('processStatus', `Processing started! Job ID: ${response.jobId}`, 'success');
                
                // Refresh jobs list
                setTimeout(loadJobs, 1000);
                
            } catch (error) {
                showStatus('processStatus', `Processing failed: ${error.message}`, 'error');
            }
        }
        
        // Load processing jobs
        async function loadJobs() {
            try {
                const response = await apiCall(`${API_BASE}/videos/jobs`);
                const jobs = response.jobs || [];
                
                let jobsHtml = '';
                
                if (jobs.length === 0) {
                    jobsHtml = '<p>No processing jobs found.</p>';
                } else {
                    jobsHtml = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Job ID</th>
                                    <th>Video</th>
                                    <th>Status</th>
                                    <th>Progress</th>
                                    <th>Format</th>
                                    <th>Resolution</th>
                                    <th>Created</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    jobs.forEach(job => {
                        const createdDate = new Date(job.created_at).toLocaleString();
                        const statusClass = job.status === 'completed' ? 'success' : 
                                          job.status === 'failed' ? 'error' : 'info';
                        
                        jobsHtml += `
                            <tr>
                                <td>${job.id.substring(0, 8)}...</td>
                                <td>${job.original_name || 'N/A'}</td>
                                <td><span class="status-message ${statusClass}">${job.status}</span></td>
                                <td>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${job.progress || 0}%"></div>
                                    </div>
                                    ${job.progress || 0}%
                                </td>
                                <td>${job.format}</td>
                                <td>${job.resolution}</td>
                                <td>${createdDate}</td>
                                <td>
                                    ${job.status === 'completed' ? 
                                        `<button onclick="downloadVideo('${job.id}')" class="btn-success">Download</button>` : 
                                        '-'}
                                </td>
                            </tr>
                        `;
                    });
                    
                    jobsHtml += '</tbody></table>';
                }
                
                document.getElementById('jobsList').innerHTML = jobsHtml;
                
            } catch (error) {
                document.getElementById('jobsList').innerHTML = `<div class="status-message error">Failed to load jobs: ${error.message}</div>`;
            }
        }
        
        async function downloadVideo(jobId) {
  try {
    const response = await fetch(`${API_BASE}/videos/download/${jobId}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${authToken}`
      }
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Download failed');
    }

    // Get the filename from the Content-Disposition header or fallback
    const contentDisposition = response.headers.get('content-disposition');
    let filename = `processed_${jobId}.mp4`; // Default filename
    if (contentDisposition) {
      const filenameMatch = contentDisposition.match(/filename="(.+)"/);
      if (filenameMatch && filenameMatch[1]) {
        filename = filenameMatch[1];
      }
    }

    // Create a blob from the response
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);

    // Create a temporary link element to trigger download
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();

    // Clean up
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);

  } catch (error) {
    alert(`Download failed: ${error.message}`);
  }
}
        
        // Auto-refresh jobs every 5 seconds when on jobs tab
        setInterval(() => {
            if (authToken && document.getElementById('jobsTab').classList.contains('active')) {
                loadJobs();
            }
        }, 5000);
        
        // Enable Enter key for login
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !document.getElementById('loginSection').classList.contains('hidden')) {
                login();
            }
        });
    </script>
</body>
</html>