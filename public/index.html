<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Transcoding App</title>
  <style>
    body {
      font-family: Arial;
      max-width: 1000px;
      margin: 20px auto;
      background: #f0f0f0;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .hidden {
      display: none;
    }
    .login-form {
      max-width: 350px;
      margin: auto;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      font-weight: bold;
    }
    input, select, button {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    .btn-danger {
      background: #dc3545;
    }
    .btn-danger:hover {
      background: #c82333;
    }
    .btn-success {
      background: #28a745;
    }
    .btn-success:hover {
      background: #218838;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .success {
      background: #d4edda;
      color: #155724;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background: #e9ecef;
    }
    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px;
      cursor: pointer;
    }
    .tab.active {
      border-bottom: 2px solid #007bff;
      color: #007bff;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .progress-bar {
      background: #e9ecef;
      border-radius: 4px;
      height: 18px;
    }
    .progress-fill {
      background: #28a745;
      height: 100%;
    }
    .file-info {
      margin: 10px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
      border: 1px solid #dee2e6;
    }
    #mfaQRCode {
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <!-- Login section -->
  <div id="loginSection" class="container">
    <h1>Video Processing - Login</h1>
    <div class="login-form">
      <!-- Toggle between login, signup, confirm, and MFA setup -->
      <div class="tabs" style="margin-bottom: 15px;">
        <div class="tab active" onclick="showLogin()">Login</div>
        <div class="tab" onclick="showSignup()">Sign Up</div>
        <div class="tab" onclick="showConfirm()">Confirm Email</div>
        <div class="tab" onclick="showMFA()">MFA Setup</div>
      </div>

      <!-- Login form -->
      <div id="loginForm">
        <div class="form-group">
          <label for="username">Username:</label>
          <input type="text" id="username" required>
        </div>
        <div class="form-group">
          <label for="password">Password:</label>
          <input type="password" id="password" required>
        </div>
        <button onclick="doLogin()">Login</button>
      </div>

      <!-- Signup form -->
      <div id="signupForm" class="hidden">
        <div class="form-group">
          <label for="signupUsername">Username:</label>
          <input type="text" id="signupUsername" required>
        </div>
        <div class="form-group">
          <label for="signupEmail">Email:</label>
          <input type="email" id="signupEmail" required>
        </div>
        <div class="form-group">
          <label for="signupPassword">Password:</label>
          <input type="password" id="signupPassword" required>
          <small>Must be 8+ chars with uppercase, lowercase, number & symbol</small>
        </div>
        <button onclick="doSignup()">Sign Up</button>
      </div>

      <!-- Confirm form -->
      <div id="confirmForm" class="hidden">
        <div class="form-group">
          <label for="confirmUsername">Username:</label>
          <input type="text" id="confirmUsername" required>
        </div>
        <div class="form-group">
          <label for="confirmCode">Confirmation Code:</label>
          <input type="text" id="confirmCode" required>
          <small>Check your email for the 6-digit code</small>
        </div>
        <button onclick="doConfirm()">Confirm Email</button>
      </div>

      <!-- MFA setup form -->
      <div id="mfaForm" class="hidden">
        <div class="form-group">
          <label>Setup Multi-Factor Authentication</label>
          <p>After clicking "Setup MFA", scan the QR code or enter the secret in your authenticator app (e.g., Google Authenticator).</p>
          <div id="mfaQRCode"></div>
          <div class="form-group">
            <label for="mfaCode">TOTP Code:</label>
            <input type="text" id="mfaCode" placeholder="Enter 6-digit code">
          </div>
          <button onclick="setupMFA()">Setup MFA</button>
        </div>
      </div>
    </div>
    <div id="loginStatus"></div>
  </div>

  <!-- Main app stuff -->
  <div id="appSection" class="hidden">
    <div class="container">
      <h1>Your Dashboard</h1>
      <div style="float: right; font-size: 14px;">
        Welcome, <span id="currentUser"></span>
        <button onclick="doLogout()" class="btn-danger" style="margin-left: 10px;">Logout</button>
      </div>

      <!-- Tabs for navigation -->
      <div class="tabs">
        <div class="tab active" onclick="switchTab('upload')">Upload & Process</div>
        <div class="tab" onclick="switchTab('videos')">My Videos</div>
        <div class="tab" onclick="switchTab('jobs')">Jobs</div>
      </div>

      <!-- Upload tab -->
      <div id="uploadTab" class="tab-content active">
        <h3>Upload a Video</h3>
        <div class="form-group">
          <label for="videoFile">Pick a video (MP4, AVI, MOV):</label>
          <input type="file" id="videoFile" accept="video/*" onchange="showFileInfo()">
        </div>
        <div id="fileInfo"></div>
        <button onclick="uploadVid()" class="btn-success">Upload</button>
        <div id="uploadStatus"></div>

        <hr>

        <h3>Process a Video</h3>
        <div class="form-group">
          <label for="videoSelect">Choose a video:</label>
          <select id="videoSelect">
            <option value="">Select a video...</option>
          </select>
        </div>
        <div style="display: flex; gap: 10px;">
          <div class="form-group">
            <label for="format">Format:</label>
            <select id="format">
              <option value="mp4">MP4</option>
              <option value="avi">AVI</option>
              <option value="mov">MOV</option>
            </select>
          </div>
          <div class="form-group">
            <label for="resolution">Resolution:</label>
            <select id="resolution">
              <option value="480p">480p</option>
              <option value="720p" selected>720p</option>
              <option value="1080p">1080p</option>
            </select>
          </div>
        </div>
        <button onclick="processVid()" class="btn-success">Process</button>
        <div id="processStatus"></div>
      </div>

      <!-- Videos tab -->
      <div id="videosTab" class="tab-content">
        <h3>My Videos</h3>
        <button onclick="getVideos()" class="btn-success">Refresh</button>
        <div id="videosList"></div>
      </div>

      <!-- Jobs tab -->
      <div id="jobsTab" class="tab-content">
        <h3>Processing Jobs</h3>
        <button onclick="getJobs()" class="btn-success">Refresh</button>
        <div id="jobsList"></div>
      </div>
    </div>
  </div>

  <script>
    // Global vars
    let token = '';
    let accessToken = ''; // Store access token for MFA
    let user = '';
    const api = '/api';

    // Helper to call API
    async function callApi(url, method = 'GET', data = null) {
      console.log('Calling API:', url);
      let config = { method, headers: {} };
      if (token) config.headers['Authorization'] = `Bearer ${token}`;
      
      if (data && !(data instanceof FormData)) {
        config.headers['Content-Type'] = 'application/json';
        config.body = JSON.stringify(data);
      } else if (data instanceof FormData) {
        config.body = data;
      }
      
      try {
        let res = await fetch(url, config);
        let json = await res.json();
        if (!res.ok) throw new Error(json.error || 'Something broke');
        return json;
      } catch (err) {
        console.error('API error:', err);
        throw err;
      }
    }

    // Show messages to user
    function showMsg(id, msg, type = 'info') {
      let el = document.getElementById(id);
      el.innerHTML = `<div class="status ${type}">${msg}</div>`;
    }
    
    // Tab switching functions
    function showLogin() {
      document.querySelectorAll('#loginSection .tab').forEach(t => t.classList.remove('active'));
      document.querySelector('#loginSection .tab:first-child').classList.add('active');
      
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('signupForm').classList.add('hidden');
      document.getElementById('confirmForm').classList.add('hidden');
      document.getElementById('mfaForm').classList.add('hidden');
    }

    function showSignup() {
      document.querySelectorAll('#loginSection .tab').forEach(t => t.classList.remove('active'));
      document.querySelector('#loginSection .tab:nth-child(2)').classList.add('active');
      
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('signupForm').classList.remove('hidden');
      document.getElementById('confirmForm').classList.add('hidden');
      document.getElementById('mfaForm').classList.add('hidden');
    }

    function showConfirm() {
      document.querySelectorAll('#loginSection .tab').forEach(t => t.classList.remove('active'));
      document.querySelector('#loginSection .tab:nth-child(3)').classList.add('active');
      
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('signupForm').classList.add('hidden');
      document.getElementById('confirmForm').classList.remove('hidden');
      document.getElementById('mfaForm').classList.add('hidden');
    }

    function showMFA() {
      document.querySelectorAll('#loginSection .tab').forEach(t => t.classList.remove('active'));
      document.querySelector('#loginSection .tab:nth-child(4)').classList.add('active');
      
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('signupForm').classList.add('hidden');
      document.getElementById('confirmForm').classList.add('hidden');
      document.getElementById('mfaForm').classList.remove('hidden');
    }

    // Signup function
    async function doSignup() {
      let username = document.getElementById('signupUsername').value;
      let email = document.getElementById('signupEmail').value;
      let password = document.getElementById('signupPassword').value;
      
      if (!username || !email || !password) {
        showMsg('loginStatus', 'All fields required!', 'error');
        return;
      }
      
      try {
        showMsg('loginStatus', 'Creating account...', 'info');
        let data = await callApi(`${api}/users/register`, 'POST', { username, email, password });
        showMsg('loginStatus', 'Account created! Check your email for confirmation code.', 'success');
        document.getElementById('confirmUsername').value = username;
        showConfirm();
      } catch (err) {
        showMsg('loginStatus', `Signup failed: ${err.message}`, 'error');
      }
    }

    // Confirm function
    async function doConfirm() {
      let username = document.getElementById('confirmUsername').value;
      let confirmationCode = document.getElementById('confirmCode').value;
      
      if (!username || !confirmationCode) {
        showMsg('loginStatus', 'Username and code required!', 'error');
        return;
      }
      
      try {
        showMsg('loginStatus', 'Confirming...', 'info');
        await callApi(`${api}/users/confirm`, 'POST', { username, confirmationCode });
        showMsg('loginStatus', 'Email confirmed! You can now login.', 'success');
        document.getElementById('username').value = username;
        showLogin();
      } catch (err) {
        showMsg('loginStatus', `Confirmation failed: ${err.message}`, 'error');
      }
    }

    // Login function with MFA support
    async function doLogin() {
      let username = document.getElementById('username').value;
      let password = document.getElementById('password').value;
      if (!username || !password) {
        showMsg('loginStatus', 'Need username and password!', 'error');
        return;
      }
      try {
        showMsg('loginStatus', 'Logging in...', 'info');
        let data = await callApi(`${api}/users/login`, 'POST', { username, password });
        
        // Handle MFA challenge
        if (data.challengeName === 'SOFTWARE_TOKEN_MFA') {
          let mfaCode = prompt('Enter your MFA code from your authenticator app:');
          if (!mfaCode) {
            showMsg('loginStatus', 'MFA code required!', 'error');
            return;
          }
          let mfaData = await callApi(`${api}/users/respond-mfa`, 'POST', {
            username,
            session: data.session,
            mfaCode
          });
          token = mfaData.authToken;
          accessToken = mfaData.tokens.accessToken;
          user = username;
          showMsg('loginStatus', 'MFA login successful!', 'success');
          document.getElementById('loginSection').classList.add('hidden');
          document.getElementById('appSection').classList.remove('hidden');
          document.getElementById('currentUser').textContent = user;
          getVideos();
          getJobs();
        } else {
          // Normal login
          token = data.authToken;
          accessToken = data.tokens.accessToken;
          user = username;
          showMsg('loginStatus', 'Logged in!', 'success');
          document.getElementById('loginSection').classList.add('hidden');
          document.getElementById('appSection').classList.remove('hidden');
          document.getElementById('currentUser').textContent = user;
          getVideos();
          getJobs();
        }
      } catch (err) {
        showMsg('loginStatus', `Login failed: ${err.message}`, 'error');
      }
    }

    // MFA setup function
    async function setupMFA() {
      try {
        showMsg('loginStatus', 'Setting up MFA...', 'info');
        let data = await callApi(`${api}/users/setup-mfa`, 'POST');
        document.getElementById('mfaQRCode').innerHTML = `
          <p>Scan this code in your authenticator app (e.g., Google Authenticator):</p>
          <p><strong>${data.secretCode}</strong></p>
          ${data.qrCodeUrl ? `<img src="${data.qrCodeUrl}" alt="MFA QR Code">` : ''}
        `;
        let mfaCode = document.getElementById('mfaCode').value;
        if (!mfaCode) {
          showMsg('loginStatus', 'Enter the TOTP code from your app and click Setup MFA again.', 'info');
          return;
        }
        await callApi(`${api}/users/verify-mfa`, 'POST', { userCode: mfaCode });
        showMsg('loginStatus', 'MFA enabled successfully! Use your authenticator app for future logins.', 'success');
        document.getElementById('mfaCode').value = '';
        document.getElementById('mfaQRCode').innerHTML = '';
        showLogin();
      } catch (err) {
        showMsg('loginStatus', `MFA setup failed: ${err.message}`, 'error');
      }
    }

    function showFileInfo() {
      const fileInput = document.getElementById('videoFile');
      const fileInfoDiv = document.getElementById('fileInfo');
      
      if (fileInput.files && fileInput.files[0]) {
        const file = fileInput.files[0];
        const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
        fileInfoDiv.innerHTML = `
          <div class="file-info">
            <strong>Selected file:</strong><br>
            Name: ${file.name}<br>
            Size: ${fileSizeMB} MB<br>
            Type: ${file.type}
          </div>
        `;
      } else {
        fileInfoDiv.innerHTML = '';
      }
    }

    function doLogout() {
      token = '';
      accessToken = '';
      user = '';
      document.getElementById('loginSection').classList.remove('hidden');
      document.getElementById('appSection').classList.add('hidden');
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
      showMsg('loginStatus', '', 'info');
    }

    function switchTab(tab) {
      document.querySelectorAll('#appSection .tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      const tabMap = {
        'upload': 0,
        'videos': 1,
        'jobs': 2
      };
      
      const tabIndex = tabMap[tab];
      if (tabIndex !== undefined) {
        document.querySelector(`#appSection .tab:nth-child(${tabIndex + 1})`).classList.add('active');
      }
      
      document.getElementById(tab + 'Tab').classList.add('active');
    }

    async function uploadVid() {
      const fileInput = document.getElementById('videoFile');
      
      if (!fileInput.files || fileInput.files.length === 0) {
        showMsg('uploadStatus', 'Pick a video first!', 'error');
        return;
      }
      
      const file = fileInput.files[0];
      
      if (!file.type.startsWith('video/')) {
        showMsg('uploadStatus', 'Please select a valid video file!', 'error');
        return;
      }
      
      const formData = new FormData();
      formData.append('videoFile', file);
      
      try {
        showMsg('uploadStatus', 'Uploading...', 'info');
        let data = await callApi(`${api}/videos/upload`, 'POST', formData);
        showMsg('uploadStatus', `Uploaded! Video ID: ${data.videoId}`, 'success');
        getVideos();
        fileInput.value = '';
        document.getElementById('fileInfo').innerHTML = '';
      } catch (err) {
        console.error('Upload error details:', err);
        showMsg('uploadStatus', `Upload failed: ${err.message}`, 'error');
      }
    }

    async function getVideos() {
      try {
        let data = await callApi(`${api}/videos`);
        let videos = data.videos || [];
        let select = document.getElementById('videoSelect');
        select.innerHTML = '<option value="">Select a video...</option>';
        let html = '';
        if (!videos.length) {
          html = '<p>No videos yet.</p>';
        } else {
          html = '<table><tr><th>ID</th><th>Name</th><th>Size</th><th>Uploaded</th></tr>';
          videos.forEach(v => {
            select.innerHTML += `<option value="${v.id}">${v.original_name}</option>`;
            let size = (v.file_size / 1024 / 1024).toFixed(2);
            let date = new Date(v.uploaded_at).toLocaleString();
            html += `<tr><td>${v.id}</td><td>${v.original_name}</td><td>${size} MB</td><td>${date}</td></tr>`;
          });
          html += '</table>';
        }
        document.getElementById('videosList').innerHTML = html;
      } catch (err) {
        document.getElementById('videosList').innerHTML = `<div class="status error">Error loading videos: ${err.message}</div>`;
      }
    }

    async function processVid() {
      let videoId = document.getElementById('videoSelect').value;
      let format = document.getElementById('format').value;
      let resolution = document.getElementById('resolution').value;
      if (!videoId) {
        showMsg('processStatus', 'Select a video first!', 'error');
        return;
      }
      try {
        showMsg('processStatus', 'Processing started...', 'info');
        let data = await callApi(`${api}/videos/process`, 'POST', { videoId, format, resolution });
        showMsg('processStatus', `Job started! ID: ${data.jobId}`, 'success');
        setTimeout(getJobs, 1000);
      } catch (err) {
        showMsg('processStatus', `Processing failed: ${err.message}`, 'error');
      }
    }

    async function getJobs() {
      try {
        let data = await callApi(`${api}/videos/jobs`);
        let jobs = data.jobs || [];
        let html = '';
        if (!jobs.length) {
          html = '<p>No jobs yet.</p>';
        } else {
          html = '<table><tr><th>Job ID</th><th>Video</th><th>Status</th><th>Progress</th><th>Format</th><th>Created</th><th>Action</th></tr>';
          jobs.forEach(j => {
            let date = new Date(j.created_at).toLocaleString();
            let statusClass = j.status === 'completed' ? 'success' : j.status === 'failed' ? 'error' : 'info';
            html += `
              <tr>
                <td>${j.id.slice(0, 8)}...</td>
                <td>${j.original_name || 'N/A'}</td>
                <td><span class="status ${statusClass}">${j.status}</span></td>
                <td><div class="progress-bar"><div class="progress-fill" style="width: ${j.progress || 0}%"></div></div>${j.progress || 0}%</td>
                <td>${j.format}</td>
                <td>${date}</td>
                <td>${j.status === 'completed' ? `<button onclick="download('${j.id}')" class="btn-success">Download</button>` : '-'}</td>
              </tr>`;
          });
          html += '</table>';
        }
        document.getElementById('jobsList').innerHTML = html;
      } catch (err) {
        document.getElementById('jobsList').innerHTML = `<div class="status error">Error loading jobs: ${err.message}</div>`;
      }
    }

    async function download(jobId) {
      try {
        console.log('Downloading job:', jobId);
        let res = await fetch(`${api}/videos/download/${jobId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!res.ok) {
          let err = await res.json();
          throw new Error(err.error || 'Download failed');
        }
        
        let data = await res.json();
        let downloadUrl = data.downloadUrl;
        let filename = data.filename;
        
        let a = document.createElement('a');
        a.href = downloadUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
      } catch (err) {
        alert(`Download failed: ${err.message}`);
      }
    }

    setInterval(() => {
      if (token && document.getElementById('jobsTab').classList.contains('active')) {
        console.log('Refreshing jobs...');
        getJobs();
      }
    }, 5000);

    document.addEventListener('keypress', e => {
      if (e.key === 'Enter' && !document.getElementById('loginSection').classList.contains('hidden')) {
        if (!document.getElementById('loginForm').classList.contains('hidden')) {
          doLogin();
        } else if (!document.getElementById('signupForm').classList.contains('hidden')) {
          doSignup();
        } else if (!document.getElementById('confirmForm').classList.contains('hidden')) {
          doConfirm();
        } else if (!document.getElementById('mfaForm').classList.contains('hidden')) {
          setupMFA();
        }
      }
    });
  </script>
</body>
</html>